worker_processes  1;

events {
    worker_connections 1024;
}

http {
    access_log /dev/stdout;
    error_log /dev/stderr warn;

    client_max_body_size 50M;

    resolver 127.0.0.11 valid=30s;

    server {
        listen 80;
        server_name localhost;

        # --- Auth (Main) ---
        location / {
            set $upstream_auth "http://auth:8081";

            proxy_pass $upstream_auth;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- Reviews ---
        location /reviews-service/ {
            set $upstream_review "http://review:8080";

            proxy_pass $upstream_review;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- Search ---
        location /search-service/ {
            set $upstream_search "http://search:8085";

            proxy_pass $upstream_search;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- Product ---
        location /product-service/ {
            set $upstream_product "http://product:8082";

            proxy_pass $upstream_product;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- Favorites ---
        location /favorites-service/ {
            set $upstream_favorites "http://favorites:8083";

            proxy_pass $upstream_favorites;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- Media ---
        location /media-service/ {
            set $upstream_media "http://media:8084";

            proxy_pass $upstream_media;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- Notification ---
        location /notification-service/ {
            set $upstream_notify "http://notify:8079";

            proxy_pass $upstream_notify;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
